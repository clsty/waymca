name: Build WayMCA

on:
  push:
    branches: [ main, master, copilot/** ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-archlinux:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    
    steps:
    - name: Update system and install base dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm base-devel git cmake extra-cmake-modules
    
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install KDE/Qt dependencies
      run: |
        pacman -S --noconfirm kwin qt6-base
    
    - name: Configure with CMake
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr
    
    - name: Build
      run: |
        cd build
        make -j$(nproc)
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: waymca-archlinux
        path: |
          build/libwaymca.so
          build/libwaymca_config.so
        retention-days: 30
    
    - name: Display build info
      run: |
        echo "Build completed successfully!"
        echo "Plugin: build/libwaymca.so"
        echo "Config: build/libwaymca_config.so"
        ls -lh build/*.so
